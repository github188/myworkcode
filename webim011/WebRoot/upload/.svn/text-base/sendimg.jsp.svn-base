<%@ page language="java" import="java.util.*" pageEncoding="utf-8"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt"%>
<%
String path = request.getContextPath();
String basePath = request.getScheme()+"://"+request.getServerName()+":"+request.getServerPort()+path+"/";
request.setAttribute("basePath",basePath);
%>
<html>
<head>
<base href="<%=basePath%>">
<title>文件上传</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="css/vip.css" type="text/css">
  <script type="text/javascript" src="${basePath}script/jquery/jquery.js"></script>
    <script type="text/javascript" src="${basePath}talk/chat.js"></script>
    <script type="text/javascript" src="${basePath}talk/js/ajaxfileupload.js"></script>
  
    <script type="text/javascript">
    function uploadFile(){
	//alert(window.parent.document.all.contentInput);
     var uploadfile=document.getElementById("uploadfile").value;
     if(uploadfile==""){
    	 alert("上传图片不能为空");
	     return false;
      }	
      	var types = ["jpg","gif","bmp","png"];
		var ext = uploadfile.substring(uploadfile.length-3).toLowerCase();
		var sing = false;
		for(var i=0; i<types.length;i++){
			if (ext==types[i]){
				sing = true; 
			}
		}
		if(!sing){
			alert("只允许上传图片!");
			return false;
		}
		ajaxFileUpload();	
    }
    
    function ajaxFileUpload(){
	 with(document.myform){
     
		  $("#loading").ajaxStart(function(){
   		 $(this).show();
   })
   .ajaxComplete(function(){
   		 $(this).hide();
   });
   $.ajaxFileUpload  
   (
    {
     url:'${basePath}im/sendImg.action?loginUserId='+$("#loginUserId").val()+"&targetId="+$("#targetId").val(),//上传调用的Action,即是上传提交的页面url
     secureuri:false,
     fileElementId:'uploadfile',//与页面处理代码中file相对应的ID值
     dataType: 'text',//返回数据类型，有text，xml，json，html,scritp,jsonp五种  
     success: function (data, status)
     { 
    	$("#msg").css("display","").html("文件已成功发送到对方!");
    	 setTimeout(function(){
				 $("#msg").fadeOut("slow");
				},2000);
		window.close(); 
     },
     error: function (data, status, e)
     {
    	
     }
    }
   )	

 }
}
    </script>
</head>
<body bgcolor="#FFFFFF" text="#000000" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<form action="" name="myform">
	<input type="hidden" id="loginUserId" name="loginUserId" value="${param.loginUserId}" />
    <input type="hidden" id="targetId" name="targetId" value="${param.targetId}" />
	<table width="98%" border="0" cellspacing="2" cellpadding="3" align="center">
    <tr bgcolor="6f8ac4"><td colspan="2"> 
    <font color="#FFFFFF">发送图片：</font>
   <span id="msg" style="display:none;color: #FFFFFF;"></span></td>
    </tr>
	<tr bgcolor="f5f5f5"> 
      <td width="22%" > <div align="right">图片：</div></td>
      <td width="78%"> <input type="file" onkeydown="return false;" id="uploadfile" name="upload" size="50"><br/>
      只允许上传图片格式文件
      </td>
    </tr>
    <tr bgcolor="f5f5f5"> 
      <td colspan="2"> <div align="center"> 
      	  
     	  <img id="loading" src="${basePath}talk/images/loading.gif" style="display:none;" align="left"/>
          <input type="button" onclick="javacript:uploadFile();" name="SYS_SET" value=" 确 定 " class="frm_btn">
          <input type="button" onclick="javacript:window.close();" name="SYS_SET" value=" 关闭 " class="frm_btn">
        </div></td>
    </tr>
  </table>
  
	</form>
<br>
</body>
</html>
